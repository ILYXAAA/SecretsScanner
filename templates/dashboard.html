<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard - Secrets Scanner</title>
    <link rel="stylesheet" href="/secret_scanner/static/css/dashboard.css">
    <link rel="icon" type="image/x-icon" href="/secret_scanner/favicon.ico">
</head>
<body>
    <header class="header">
        <a href="/secret_scanner/dashboard" class="logo">
            üîç Secrets Scanner
        </a>
        <nav class="nav-links">
            <a href="/secret_scanner/dashboard">üåê –ì–ª–∞–≤–Ω–∞—è</a>
            <a href="/secret_scanner/multi-scan">üîÑ –ú—É–ª—å—Ç–∏—Å–∫–∞–Ω</a>
            {% if current_user == "admin" %}
                <a href="/secret_scanner/admin">üëë –ê–¥–º–∏–Ω –ø–∞–Ω–µ–ª—å</a>
                <a href="/secret_scanner/admin/workers" class="active">‚öôÔ∏è –°–µ—Ä–≤–∏—Å</a>
            {% endif %}
            <a href="/secret_scanner/settings">‚öôÔ∏è –ù–∞—Å—Ç—Ä–æ–π–∫–∏</a>
            <a href="/secret_scanner/logout">üîö –í—ã–π—Ç–∏</a>
        </nav>
    </header>
    
    <div class="container">
        <div class="page-header">
            <h1 class="page-title">üåê –ì–ª–∞–≤–Ω–∞—è</h1>
        </div>
        
        {% if request.url.query %}
            {% if 'success=project_added' in request.url.query %}
            <div class="alert alert-success">–ü—Ä–æ–µ–∫—Ç —É—Å–ø–µ—à–Ω–æ –¥–æ–±–∞–≤–ª–µ–Ω</div>
            {% elif 'success=project_updated' in request.url.query %}
            <div class="alert alert-success">–î–∞–Ω–Ω—ã–µ –ø—Ä–æ–µ–∫—Ç–∞ —É—Å–ø–µ—à–Ω–æ –æ–±–Ω–æ–≤–ª–µ–Ω—ã</div>
            {% elif 'success=project_deleted' in request.url.query %}
            <div class="alert alert-success">–ü—Ä–æ–µ–∫—Ç —É—Å–ø–µ—à–Ω–æ —É–¥–∞–ª–µ–Ω</div>
            {% elif 'error=project_exists' in request.url.query %}
            <div class="alert alert-error">–ü—Ä–æ–µ–∫—Ç —Å —Ç–∞–∫–∏–º –∏–º–µ–Ω–µ–º —É–∂–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç</div>
            {% elif 'error=empty_project_name' in request.url.query %}
            <div class="alert alert-error">–ò–º—è –ø—Ä–æ–µ–∫—Ç–∞ –Ω–µ –º–æ–∂–µ—Ç –±—ã—Ç—å –ø—É—Å—Ç—ã–º</div>
            {% elif 'error=invalid_project_name' in request.url.query %}
            <div class="alert alert-error">–ò–º—è –ø—Ä–æ–µ–∫—Ç–∞ —Å–æ–¥–µ—Ä–∂–∏—Ç –Ω–µ–¥–æ–ø—É—Å—Ç–∏–º—ã–µ —Å–∏–º–≤–æ–ª—ã</div>
            {% elif 'error=project_not_found' in request.url.query %}
            <div class="alert alert-error">–ü—Ä–æ–µ–∫—Ç –Ω–µ –Ω–∞–π–¥–µ–Ω</div>
            {% elif 'error=unexpected_error' in request.url.query %}
            <div class="alert alert-error">–ü—Ä–æ–∏–∑–æ—à–ª–∞ –Ω–µ–æ–∂–∏–¥–∞–Ω–Ω–∞—è –æ—à–∏–±–∫–∞</div>
            {% elif 'error=' in request.url.query %}
            <div class="alert alert-error">{{ request.url.query.split('error=')[1] | urldecode }}</div>
            {% endif %}
        {% endif %}
        
        <div class="tabs">
            <button class="tab active" onclick="switchTab('recent-scans')">üìä –ü–æ—Å–ª–µ–¥–Ω–∏–µ —Å–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏—è</button>
            <button class="tab" onclick="switchTab('projects')">üóÇÔ∏è –ü—Ä–æ–µ–∫—Ç—ã</button>
        </div>
        
        <!-- Recent Scans Tab -->
        <div id="recent-scans" class="tab-content active">
            {% if recent_scans %}
            <div class="scan-list">
                {% for scan_data in recent_scans %}
                <a href="{% if scan_data.scan.status == 'completed' %}/secret_scanner/scan/{{ scan_data.scan.id }}/results{% elif scan_data.scan.status == 'running' %}/secret_scanner/scan/{{ scan_data.scan.id }}{% else %}/secret_scanner/project/{{ scan_data.scan.project_name }}{% endif %}" class="scan-item{% if scan_data.scan.status == 'failed' %} scan-failed{% elif scan_data.scan.status == 'timeout' %} scan-timeout{% endif %}">
                    <div class="scan-main">
                        <div class="scan-project">{{ scan_data.scan.project_name }}</div>
                        <div class="scan-meta">
                            <span class="scan-status {{ scan_data.scan.status }}">
                                {% if scan_data.scan.status == 'running' %}‚è≥ –í—ã–ø–æ–ª–Ω—è–µ—Ç—Å—è
                                {% elif scan_data.scan.status == 'completed' %}‚úÖ –ó–∞–≤–µ—Ä—à–µ–Ω–æ
                                {% elif scan_data.scan.status == 'failed' %}‚ùå –û—à–∏–±–∫–∞
                                {% else %}‚è∏Ô∏è –¢–∞–π–º–∞—É—Ç
                                {% endif %}
                            </span>
                        </div>
                        <div class="scan-meta">
                            {% if scan_data.scan.started_by %}
                            <span style="color: #3b82f6;">üëÆ {{ scan_data.scan.started_by }}</span>
                            {% endif %}
                        </div>
                        <div class="scan-meta">
                            üïí –°–æ–∑–¥–∞–Ω : {{ scan_data.scan.started_at.strftime('%d.%m.%Y %H:%M') }}
                        </div>
                        <div class="scan-meta">
                            {% if scan_data.scan.repo_commit %}
                            ‚öôÔ∏è Commit: {{ scan_data.scan.repo_commit }}
                            {% endif %}
                        </div>
                    </div>
                    {% if scan_data.scan.status == 'completed' %}
                    <div class="scan-stats">
                        <div class="secrets-summary">
                            <div class="secret-count high">
                                <div class="number">{{ scan_data.high_count }}</div>
                                <div class="label">High</div>
                            </div>
                            <div class="secret-count potential">
                                <div class="number">{{ scan_data.potential_count }}</div>
                                <div class="label">Potential</div>
                            </div>
                        </div>
                        {% if scan_data.scan.files_scanned %}
                        <div style="font-size: 0.8rem; color: #666; margin-top: 0.5rem;">
                            üìÅ {{ scan_data.scan.files_scanned }} —Ñ–∞–π–ª–æ–≤
                        </div>
                        {% endif %}
                    </div>
                    {% elif scan_data.scan.status == 'running' and scan_data.scan.files_scanned %}
                    <div class="scan-stats">
                        <div style="font-size: 0.9rem; color: #666;">
                            üìÅ {{ scan_data.scan.files_scanned }} —Ñ–∞–π–ª–æ–≤
                        </div>
                    </div>
                    {% endif %}
                </a>
                {% endfor %}
            </div>
            {% else %}
            <div class="empty-state">
                <h3>ü§∑‚Äç‚ôÇÔ∏è –ù–µ—Ç —Å–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–π</h3>
                <p>–ó–∞–ø—É—Å—Ç–∏—Ç–µ —Å–≤–æ–µ –ø–µ—Ä–≤–æ–µ —Å–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ, —Å–æ–∑–¥–∞–≤ –ø—Ä–æ–µ–∫—Ç –∏ –∑–∞–ø—É—Å—Ç–∏–≤ –∞–Ω–∞–ª–∏–∑.</p>
            </div>
            {% endif %}
        </div>
        
        <!-- Projects Tab -->
        <div id="projects" class="tab-content">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 2rem;">
                <div class="search-bar">
                    <form method="get">
                        <input type="text" name="search" placeholder="–ü–æ–∏—Å–∫ –ø—Ä–æ–µ–∫—Ç–æ–≤..." value="{{ search }}">
                        <input type="hidden" name="page" value="1">
                    </form>
                </div>
                <button class="btn btn-primary" onclick="toggleAddForm()">
                    üìë –ù–æ–≤—ã–π –ø—Ä–æ–µ–∫—Ç
                </button>
            </div>
            
            <div class="add-project-form" id="addProjectForm">
                <h3>–î–æ–±–∞–≤–∏—Ç—å –Ω–æ–≤—ã–π –ø—Ä–æ–µ–∫—Ç</h3>
                <form method="post" action="/secret_scanner/projects/add">
                    <div class="form-group">
                        <label for="project_name">–ù–∞–∑–≤–∞–Ω–∏–µ –ø—Ä–æ–µ–∫—Ç–∞</label>
                        <input type="text" id="project_name" name="project_name" placeholder="Project_Repository" required 
                               pattern="[a-zA-Z0-9._\-\s]+" 
                               title="–î–æ–ø—É—Å—Ç–∏–º—ã –±—É–∫–≤—ã, —Ü–∏—Ñ—Ä—ã, —Ç–æ—á–∫–∏, –¥–µ—Ñ–∏—Å—ã, –ø–æ–¥—á–µ—Ä–∫–∏–≤–∞–Ω–∏—è –∏ –ø—Ä–æ–±–µ–ª—ã">
                    </div>
                    <div class="form-group">
                        <label for="repo_url">–°—Å—ã–ª–∫–∞ –Ω–∞ —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–π</label>
                        {% if HUB_TYPE == "Azure" %}
                        <input type="text" id="repo_url" name="repo_url" 
                               placeholder="https://server/Collection/Project/_git/Repository" required>
                        <small style="color: #444; font-size: 0.85rem;">
                        <div style="display: flex; align-items: center; gap: 6px; font-weight: bold; color: #e09122; margin-bottom: 4px;">
                            <span style="font-size: 1rem;">‚ö†Ô∏è</span>
                            <span style="font-size: 0.95rem;">–í–∞–∂–Ω–æ</span>
                        </div>

                        <b>–§–æ—Ä–º–∞—Ç –¥–ª—è –ù–∞–∑–≤–∞–Ω–∏—è –ø—Ä–æ–µ–∫—Ç–∞</b> 
                        <span style="color: #28a745;">(recommended)</span>:<br>
                        ‚Ä¢ https://../TFS/../Project1/_git/Repo1 ‚îà‚û§ <b>Project1_Repo1</b><br><br>

                        <b>–§–æ—Ä–º–∞—Ç —Å—Å—ã–ª–æ–∫ –¥–ª—è Azure DevOps</b> 
                        <span style="color: #dc3545;">(required)</span>:<br>
                        ‚Ä¢ https://server/collection/project/<span style="color: #dc3545;">_git</span>/repository <b>(full format)</b><br>
                        ‚Ä¢ https://server/collection/<span style="color: #dc3545;">_git</span>/repository <b>(short format)</b><br><br>

                        <b>–§–æ—Ä–º–∞—Ç —Å—Å—ã–ª–æ–∫ –¥–ª—è DevZone</b> 
                        <span style="color: #17a2b8;">(–ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç—Å—è)</span>:<br>
                        ‚Ä¢ git@git.devzone.local:devzone/project/repo.git<br>
                        ‚Ä¢ https://git.devzone.local/devzone/project/repo<br>
                        <span style="color: #28a745; font-weight: bold;">‚úÖ DevZone –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç –æ–Ω–ª–∞–π–Ω —Å–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ –ø–æ –∫–æ–º–º–∏—Ç—É, —Ç–µ–≥—É –∏–ª–∏ –≤–µ—Ç–∫–µ</span>
                        </small>
                        {% else %}
                        <input type="text" id="repo_url" name="repo_url" 
                               placeholder="https://github.com/user/repo" required>
                        <small style="color: #666; font-size: 0.85rem;">
                            –ü–æ–¥–¥–µ—Ä–∂–∏–≤–∞—é—Ç—Å—è GitHub, Azure –∏ DevZone
                        </small>
                        {% endif %}
                    </div>
                    <div class="form-actions">
                        <button type="submit" class="btn btn-primary">–î–æ–±–∞–≤–∏—Ç—å –ø—Ä–æ–µ–∫—Ç</button>
                        <button type="button" class="btn btn-secondary" onclick="toggleAddForm()">–ù–∞–∑–∞–¥</button>
                    </div>
                </form>
            </div>
            
            {% if projects %}
            <div class="projects-list">
                {% for project_data in projects %}
                <a href="/secret_scanner/project/{{ project_data.project.name }}" class="project-card">
                    <div class="project-main">
                        <div class="project-name">
                            <span class="project-icon">üìÅ</span>
                            {{ project_data.project.name }}
                        </div>
                        <div class="project-url">üîó {{ project_data.project.repo_url }}</div>
                        <div class="project-meta">
                            üïí –°–æ–∑–¥–∞–Ω: {{ project_data.project.created_at.strftime('%d.%m.%Y %H:%M') }}
                        </div>
                        <div class="project-meta">
                            {% if project_data.project.created_by %}
                            <span style="color: #3b82f6;">üëÆ {{ project_data.project.created_by }}</span>
                            {% endif %}
                        </div>

                    </div>
                    {% if project_data.latest_scan %}
                    <div class="project-scan-info">
                        <div class="last-scan-date">{{ project_data.latest_scan.started_at.strftime('%d.%m.%Y %H:%M') }}</div>
                        {% if project_data.latest_scan.repo_commit %}
                        <div class="last-scan-commit">{{ project_data.latest_scan.repo_commit[:7] }}</div>
                        {% endif %}
                        {% if project_data.latest_scan.status == 'completed' %}
                        <div class="secrets-summary">
                            <div class="secret-count high">
                                <div class="number">{{ project_data.high_count or 0 }}</div>
                                <div class="label">High</div>
                            </div>
                            <div class="secret-count potential">
                                <div class="number">{{ project_data.potential_count or 0 }}</div>
                                <div class="label">Potential</div>
                            </div>
                        </div>
                        {% else %}
                        <div class="scan-status {{ project_data.latest_scan.status }}">
                            {% if project_data.latest_scan.status == 'running' %}‚è≥ –í—ã–ø–æ–ª–Ω—è–µ—Ç—Å—è
                            {% elif project_data.latest_scan.status == 'failed' %}‚ùå –û—à–∏–±–∫–∞
                            {% else %}‚è∏Ô∏è –¢–∞–π–º–∞—É—Ç
                            {% endif %}
                        </div>
                        {% endif %}
                    </div>
                    {% endif %}
                    <div class="project-actions" onclick="event.preventDefault(); event.stopPropagation();">
                        <button class="btn btn-danger btn-sm btn-icon" title="Delete"
                                onclick="deleteProject({{ project_data.project.id }})">
                            üóëÔ∏è
                        </button>
                    </div>
                </a>
                {% endfor %}
            </div>
            
            {% if total_pages > 1 %}
            <div class="pagination">
                {% set current_group = ((current_page - 1) // 10) %}
                {% set start_page = current_group * 10 + 1 %}
                {% set end_page = [start_page + 9, total_pages] | min %}
                
                {% if current_group > 0 %}
                <a href="?page={{ start_page - 1 }}&search={{ search }}">&larr; Previous</a>
                {% endif %}
                
                {% for page_num in range(start_page, end_page + 1) %}
                    {% if page_num == current_page %}
                    <a href="#" class="current">{{ page_num }}</a>
                    {% else %}
                    <a href="?page={{ page_num }}&search={{ search }}">{{ page_num }}</a>
                    {% endif %}
                {% endfor %}
                
                {% if end_page < total_pages %}
                <a href="?page={{ end_page + 1 }}&search={{ search }}">Next &rarr;</a>
                {% endif %}
            </div>
            {% endif %}
            
            {% else %}
            <div class="empty-state">
                <h3>ü§∑‚Äç‚ôÇÔ∏è –ù–∏—á–µ–≥–æ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ</h3>
                <p>{% if search %}–ù–∏ –æ–¥–∏–Ω –ø—Ä–æ–µ–∫—Ç –Ω–µ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É–µ—Ç –≤–∞—à–∏–º –∫—Ä–∏—Ç–µ—Ä–∏—è–º –ø–æ–∏—Å–∫–∞.{% else %}–ù–∞—á–Ω–∏—Ç–µ —Å –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –ø–µ—Ä–≤–æ–≥–æ –ø—Ä–æ–µ–∫—Ç–∞.{% endif %}</p>
            </div>
            {% endif %}
        </div>
    </div>
    <script src="/secret_scanner/static/js/dashboard.js"></script>
</body>
</html>