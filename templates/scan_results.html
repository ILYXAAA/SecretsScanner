<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Scan Results - {{ project.name }}</title>
    <link rel="stylesheet" href="/secret_scanner/static/css/base_header.css">
    <link rel="stylesheet" href="/secret_scanner/static/css/scan_results.css">
    <link rel="icon" type="image/x-icon" href="/secret_scanner/favicon.ico">
</head>
<body data-project-repo-url="{{ project.repo_url }}" 
      data-scan-commit="{{ scan.repo_commit }}" 
      data-hub-type="{{ HUB_TYPE }}">
    <script type="application/json" id="secrets-data">{{ secrets_data | tojson | safe }}</script>
    {% from "components/base_header.html" import header %}
    {{ header('', current_user) }}
    
    <div class="main-content">
        <div class="left-panel" id="leftPanel">
            <div class="panel-header">
                <div class="project-info">
                    <div class="project-title">{{ project.name }}</div>
                    {% if project.repo_url and scan.repo_commit %}
                    <a href="{{ project.repo_url }}/commit/{{ scan.repo_commit }}" 
                       target="_blank" 
                       class="repo-link">
                        üîó {{ project.repo_url }}/commit/{{ scan.repo_commit[:8] }}...
                    </a>
                    {% endif %}
                    <div class="commit-info">
                        ‚öôÔ∏è Commit: <span style="font-weight: bold; color: #3b82f6;">{{ scan.repo_commit if scan.repo_commit else 'Unknown' }}</span>
                    </div>
                    {% if scan.started_by %}
                    <div class="commit-info">
                        üëÆ –ó–∞–ø—É—â–µ–Ω –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–º: <span style="font-weight: bold; color: #3b82f6;">{{ scan.started_by }}</span>
                    </div>
                    {% endif %}
                    <div class="commit-info">
                        üïí –ó–∞–≤–µ—Ä—à–µ–Ω: <span style="font-weight: bold; color: #3b82f6;">{{ scan.completed_at.strftime('%d.%m.%Y %H:%M') if scan.completed_at else scan.started_at.strftime('%d.%m.%Y %H:%M') }}</span>
                    </div>
                    {% if scan.files_scanned %}
                    <div class="commit-info">
                        üìÇ –í—Å–µ–≥–æ —Ñ–∞–π–ª–æ–≤: <span style="font-weight: bold; color: #3b82f6;">{{ scan.files_scanned }}</span>
                    </div>
                    {% endif %}
                    {% if scan.excluded_files_count %}
                    <div class="commit-info">
                        üö´ –§–∞–π–ª–æ–≤ –∏—Å–∫–ª—é—á–µ–Ω–æ by rules: <span style="font-weight: bold; color: #3b82f6;">{{ scan.excluded_files_count }}</span>
                    </div>
                    {% endif %}
                    {% if scan.excluded_files_list %}
                    <div class="commit-info">
                        üß© –°–ø–∏—Å–æ–∫ –∏—Å–∫–ª—é—á–µ–Ω–Ω—ã—Ö —Ñ–∞–π–ª–æ–≤: 
                        <span style="font-weight: bold; color: #3b82f6;" 
                            title="{{ scan.excluded_files_list }}">
                            {% if scan.excluded_files_list|length > 100 %}
                                {{ scan.excluded_files_list[:100] }}...
                            {% else %}
                                {{ scan.excluded_files_list }}
                            {% endif %}
                        </span>
                    </div>
                    {% endif %}
                </div>
                                
                <div class="stats-summary">
                    <div class="stat-item">
                        <div class="stat-number" id="totalSecretsCount">
                            {{ total_secrets if total_secrets is defined else (secrets|selectattr('is_exception', 'equalto', False)|list|length) }}
                        </div>
                        <div class="stat-label">Total</div>
                    </div>
                    <div class="stat-item high-bg">
                        <div class="stat-number high-text" id="highSecretsCount">
                            {{ high_secrets if high_secrets is defined else (secrets|selectattr('severity', 'equalto', 'High')|selectattr('is_exception', 'equalto', False)|list|length) }}
                        </div>
                        <div class="stat-label high-text">High</div>
                    </div>
                    <div class="stat-item potential-bg">
                        <div class="stat-number" id="potentialSecretsCount">
                            {{ potential_secrets if potential_secrets is defined else (secrets|selectattr('severity', 'equalto', 'Potential')|selectattr('is_exception', 'equalto', False)|list|length) }}
                        </div>
                        <div class="stat-label">Potential</div>
                    </div>
                </div>
                
                <div class="actions-row">
                    <div class="left-actions">
                        <a href="/secret_scanner/project/{{ project.name }}" class="btn btn-secondary">‚Üê Back to Project</a>
                        
                        <!-- –ü–æ–∏—Å–∫ –ø–æ —Å–µ–∫—Ä–µ—Ç—É -->
                        <div style="display: flex; align-items: center; gap: 0.5rem; margin-left: 1rem;">
                            <label for="secretValueFilterMain" style="font-size: 0.875rem; color: #6b7280; font-weight: 500;">üîç –ü–æ–∏—Å–∫:</label>
                            <input type="text" id="secretValueFilterMain" placeholder="–í–≤–µ–¥–∏—Ç–µ —á–∞—Å—Ç—å —Å–µ–∫—Ä–µ—Ç–∞..." 
                                style="padding: 0.375rem 0.75rem; border: 1px solid #e5e7eb; border-radius: 6px; font-size: 0.875rem; width: 200px;"
                                oninput="applyFiltersFromMain()">
                        </div>
                    </div>
                    <div class="right-actions">
                        <button class="btn btn-info" onclick="toggleFiltersPanel()" id="filtersToggleBtn">üîç –§–∏–ª—å—Ç—Ä—ã</button>
                        <a href="/secret_scanner/scan/{{ scan.id }}/export" class="btn btn-success">üìã Export JSON</a>
                        <a href="/secret_scanner/scan/{{ scan.id }}/export-html" class="btn btn-primary">üíæ Export HTML</a>
                        <form method="post" action="/secret_scanner/scan/{{ scan.id }}/delete" style="display: inline;" 
                            onsubmit="return confirm('Are you sure you want to delete this scan and all its data?')">
                            <button type="submit" class="btn btn-danger">üóëÔ∏è –£–¥–∞–ª–∏—Ç—å —Å–∫–∞–Ω</button>
                        </form>
                    </div>
                </div>
            </div>

            <div class="secrets-table-container" id="secretsTableContainer">
                <div id="secretsTable">
                    <!-- Table will be populated by JavaScript -->
                </div>
            </div>

            <div class="pagination-container" id="paginationContainer">
                <div class="pagination-info" id="paginationInfo">
                    <!-- Pagination info will be populated by JavaScript -->
                </div>
                <div class="pagination-controls" id="paginationControls">
                    <!-- Pagination controls will be populated by JavaScript -->
                </div>
                <div class="page-size-selector">
                    <label for="pageSize">–ó–∞–ø–∏—Å–µ–π –Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü—É:</label>
                    <select id="pageSize" onchange="changePageSize()">
                        <option value="1000">1000</option>
                        <option value="2000" selected>2000</option>
                        <option value="5000">5000</option>
                        <option value="10000">10000</option>
                    </select>
                </div>
            </div>
        </div>
        
        <div class="right-panel" id="rightPanel">
            <div class="panel-header" style="display: flex; justify-content: space-between; align-items: center;">
                <h3>Secret Details</h3>
                <button class="btn btn-danger" onclick="openAddSecretModal()" style="font-size: 0.875rem;">
                    ‚ûï –ù–æ–≤—ã–π —Å–µ–∫—Ä–µ—Ç
                </button>
            </div>
            <div class="detail-panel" id="detailPanel">
                <div class="detail-empty">
                    <div style="text-align: center; padding: 2rem;">
                        <div style="font-size: 3rem; margin-bottom: 1rem;">üëà</div>
                        <h3>–í—ã–±–µ—Ä–∏—Ç–µ —Å–µ–∫—Ä–µ—Ç, —á—Ç–æ–±—ã –ø—Ä–æ—Å–º–æ—Ç—Ä–µ—Ç—å –ø–æ–¥—Ä–æ–±–Ω—É—é –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é</h3>
                        <p>–ù–∞–∂–º–∏—Ç–µ –Ω–∞ –ª—é–±–æ–π —Å–µ–∫—Ä–µ—Ç –∏–∑ —Å–ø–∏—Å–∫–∞, —á—Ç–æ–±—ã –ø—Ä–æ—Å–º–æ—Ç—Ä–µ—Ç—å –ø–æ–¥—Ä–æ–±–Ω—É—é –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é, —É–ø—Ä–∞–≤–ª—è—Ç—å –µ–≥–æ —Å—Ç–∞—Ç—É—Å–æ–º –∏ –ø–æ–ª—É—á–∏—Ç—å –¥–æ—Å—Ç—É–ø –∫ —Ä–∞—Å–ø–æ–ª–æ–∂–µ–Ω–∏—é —Ñ–∞–π–ª–∞.</p>
                        <div style="margin-top: 2rem; padding: 1rem; background: #f0f9ff; border-radius: 8px; border-left: 4px solid #3b82f6;">
                            <strong>üí° –°–æ–≤–µ—Ç:</strong> –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ <kbd>Ctrl</kbd> –¥–ª—è –≤—ã–¥–µ–ª–µ–Ω–∏—è –Ω–µ—Å–∫–æ–ª—å–∫–∏—Ö —Å–µ–∫—Ä–µ—Ç–æ–≤ –∏–ª–∏ <kbd>Shift</kbd> –¥–ª—è –≤—ã–¥–µ–ª–µ–Ω–∏—è –¥–∏–∞–ø–∞–∑–æ–Ω–∞.
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Filters Panel -->
    <div class="filters-panel" id="filtersPanel">
        <div class="filters-header">
            <h3 class="filters-title">üîç –§–∏–ª—å—Ç—Ä—ã</h3>
            <button class="filters-close" onclick="toggleFiltersPanel()">√ó</button>
        </div>
        <div class="filters-content">
            <div class="filter-group">
                <h4>üìä –°—Ç–∞—Ç—É—Å</h4>
                <div class="checkbox-item">
                    <input type="checkbox" id="status-confirmed" value="Confirmed" onchange="applyFilters()">
                    <label for="status-confirmed">‚úÖ Confirmed</label>
                </div>
                <div class="checkbox-item">
                    <input type="checkbox" id="status-none" value="No status" onchange="applyFilters()">
                    <label for="status-none">‚ö™ –ë–µ–∑ —Å—Ç–∞—Ç—É—Å–∞</label>
                </div>
                <div class="checkbox-item">
                    <input type="checkbox" id="status-refuted" value="Refuted" onchange="applyFilters()">
                    <label for="status-refuted">‚ùå Refuted</label>
                </div>
            </div>

            <div class="filter-group">
                <h4>‚ö†Ô∏è –£—Ä–æ–≤–µ–Ω—å</h4>
                <div class="checkbox-item">
                    <input type="checkbox" id="severity-high" value="High" onchange="applyFilters()">
                    <label for="severity-high">üõë High</label>
                </div>
                <div class="checkbox-item">
                    <input type="checkbox" id="severity-potential" value="Potential" onchange="applyFilters()">
                    <label for="severity-potential">üîò Potential</label>
                </div>
            </div>

            <div class="filter-group">
                <h4>üè∑Ô∏è –¢–∏–ø</h4>
                <div id="typeFilters">
                    <!-- Type filters will be populated by JavaScript -->
                </div>
            </div>
        </div>
        <div class="filters-actions">
            <button class="clear-filters-btn" onclick="clearAllFilters()">–û—á–∏—Å—Ç–∏—Ç—å –≤—Å–µ —Ñ–∏–ª—å—Ç—Ä—ã</button>
        </div>
    </div>

    <!-- Loading Overlay -->
    <div class="loading-overlay" id="loadingOverlay">
        <div class="loading-spinner"></div>
    </div>

    <div id="addSecretModal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1000;">
        <div style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); background: white; padding: 2rem; border-radius: 12px; width: 90%; max-width: 600px; max-height: 90vh; overflow-y: auto;">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem;">
                <h3 style="margin: 0; color: #1f2937;">–î–æ–±–∞–≤–∏—Ç—å –Ω–æ–≤—ã–π —Å–µ–∫—Ä–µ—Ç</h3>
                <button onclick="closeAddSecretModal()" style="background: none; border: none; font-size: 1.5rem; cursor: pointer; color: #6b7280;">√ó</button>
            </div>
            
            <form id="addSecretForm" onsubmit="submitCustomSecret(event)">
                <div style="margin-bottom: 1rem;">
                    <label style="display: block; margin-bottom: 0.5rem; font-weight: 600; color: #374151;">–ó–Ω–∞—á–µ–Ω–∏–µ —Å–µ–∫—Ä–µ—Ç–∞ *</label>
                    <input type="text" id="secretValue" required style="width: 100%; padding: 0.75rem; border: 1px solid #e5e7eb; border-radius: 6px; font-family: monospace;">
                </div>
                
                <div style="margin-bottom: 1rem;">
                    <label style="display: block; margin-bottom: 0.5rem; font-weight: 600; color: #374151;">–ö–æ–Ω—Ç–µ–∫—Å—Ç</label>
                    <textarea id="secretContext" rows="3" style="width: 100%; padding: 0.75rem; border: 1px solid #e5e7eb; border-radius: 6px; font-family: monospace; resize: vertical;"></textarea>
                </div>
                
                <div style="margin-bottom: 1rem;">
                    <label style="display: block; margin-bottom: 0.5rem; font-weight: 600; color: #374151;">–ù–æ–º–µ—Ä —Å—Ç—Ä–æ–∫–∏ *</label>
                    <input type="number" id="secretLine" required min="1" style="width: 100%; padding: 0.75rem; border: 1px solid #e5e7eb; border-radius: 6px;">
                </div>
                
                <div style="margin-bottom: 1rem;">
                    <label style="display: block; margin-bottom: 0.5rem; font-weight: 600; color: #374151;">–¢–∏–ø *</label>
                    <input type="text" id="secretType" required placeholder="–Ω–∞–ø—Ä–∏–º–µ—Ä: API Key, Database Password" style="width: 100%; padding: 0.75rem; border: 1px solid #e5e7eb; border-radius: 6px;">
                </div>
                
                <div style="margin-bottom: 1.5rem;">
                    <label style="display: block; margin-bottom: 0.5rem; font-weight: 600; color: #374151;">–ü—É—Ç—å –¥–æ —Ñ–∞–π–ª–∞ *</label>
                    <input type="text" id="secretPath" required placeholder="/secret_scanner/path/to/file.env –∏–ª–∏ –ø–æ–ª–Ω–∞—è —Å—Å—ã–ª–∫–∞" style="width: 100%; padding: 0.75rem; border: 1px solid #e5e7eb; border-radius: 6px; font-family: monospace;">
                </div>
                
                <div style="display: flex; gap: 1rem; justify-content: flex-end;">
                    <button type="button" onclick="closeAddSecretModal()" style="padding: 0.75rem 1.5rem; border: 1px solid #e5e7eb; background: white; color: #374151; border-radius: 6px; cursor: pointer;">
                        –û—Ç–º–µ–Ω–∞
                    </button>
                    <button type="submit" style="padding: 0.75rem 1.5rem; border: none; background: #dc2626; color: white; border-radius: 6px; cursor: pointer; font-weight: 600;">
                        –î–æ–±–∞–≤–∏—Ç—å —Å–µ–∫—Ä–µ—Ç
                    </button>
                </div>
            </form>
        </div>
    </div>
    <script src="/secret_scanner/static/js/scan_results.js"></script>
</body>
</html>