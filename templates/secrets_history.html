<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Secrets History - {{ project.name }}</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #fafbfc;
            color: #1f2937;
            height: 100vh;
            overflow: hidden;
        }
        
        .header {
            background: #ffffff;
            padding: 1.25rem 2rem;
            border-bottom: 1px solid #e5e7eb;
            display: flex;
            align-items: center;
            justify-content: space-between;
            height: 72px;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.05);
        }
        
        .logo {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            font-size: 1.375rem;
            font-weight: 700;
            color: #1f2937;
            text-decoration: none;
        }
        
        .nav-links {
            display: flex;
            gap: 0.5rem;
            align-items: center;
        }
        
        .nav-links a {
            color: #6b7280;
            text-decoration: none;
            padding: 0.625rem 1rem;
            border-radius: 8px;
            transition: all 0.2s ease;
            font-weight: 500;
            font-size: 0.9rem;
        }
        
        .nav-links a:hover {
            background: #f3f4f6;
            color: #374151;
        }
        
        .main-content {
            display: flex;
            height: calc(100vh - 72px);
        }
        
        .left-panel {
            width: 60%;
            background: #ffffff;
            border-right: 1px solid #e5e7eb;
            display: flex;
            flex-direction: column;
        }

        .right-panel {
            width: 40%;
            background: #fafbfc;
            display: flex;
            flex-direction: column;
        }
        
        .panel-header {
            padding: 1rem 2rem;
            border-bottom: 1px solid #e5e7eb;
            background: #ffffff;
        }
        
        .project-title {
            font-size: 1.375rem;
            font-weight: 700;
            color: #1f2937;
            margin-bottom: 0.5rem;
        }
        
        .repo-link {
            color: #3b82f6;
            text-decoration: none;
            font-family: monospace;
            font-size: 0.8125rem;
            font-weight: 500;
            margin-bottom: 0.5rem;
            display: inline-block;
            padding: 0.25rem 0.5rem;
            background: #eff6ff;
            border-radius: 4px;
            border: 1px solid #dbeafe;
            transition: all 0.2s ease;
        }
        
        .repo-link:hover {
            background: #dbeafe;
        }
        
        .commit-info {
            color: #6b7280;
            font-family: monospace;
            font-size: 0.75rem;
            margin-bottom: 0.25rem;
            font-weight: 500;
        }
        
        .stats-summary {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 0.75rem;
            margin-bottom: 1rem;
        }
        
        .stat-item {
            background: #f9fafb;
            padding: 0.75rem;
            border-radius: 8px;
            text-align: center;
            border: 1px solid #e5e7eb;
        }
        
        .stat-number {
            font-size: 1.5rem;
            font-weight: 700;
            color: #059669;
            margin-bottom: 0.25rem;
        }
        
        .stat-label {
            font-size: 0.75rem;
            color: #6b7280;
            text-transform: uppercase;
            font-weight: 600;
        }
        
        .actions-row {
            display: flex;
            gap: 1rem;
            align-items: center;
            justify-content: space-between;
        }

        .left-actions {
            display: flex;
            gap: 0.5rem;
            align-items: center;
        }

        .right-actions {
            display: flex;
            gap: 0.5rem;
            align-items: center;
        }
        
        .btn {
            padding: 0.5rem 1rem;
            border: none;
            border-radius: 6px;
            font-weight: 500;
            cursor: pointer;
            text-decoration: none;
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            font-size: 0.875rem;
            transition: all 0.2s ease;
        }
        
        .btn-secondary {
            background: #6b7280;
            color: white;
        }
        
        .btn-secondary:hover {
            background: #4b5563;
        }

        .btn-info {
            background: #06b6d4;
            color: white;
        }

        .btn-info:hover {
            background: #0891b2;
        }
        
        .search-input {
            padding: 0.5rem;
            border: 1px solid #e5e7eb;
            border-radius: 6px;
            font-size: 0.875rem;
            width: 200px;
        }
        
        /* FILTERS PANEL */
        .filters-panel {
            position: fixed;
            top: 72px;
            right: -320px;
            width: 320px;
            height: calc(100vh - 72px);
            background: #ffffff;
            border-left: 1px solid #e5e7eb;
            box-shadow: -4px 0 8px rgba(0, 0, 0, 0.1);
            transition: right 0.3s ease;
            z-index: 100;
            display: flex;
            flex-direction: column;
        }

        .filters-panel.open {
            right: 0;
        }

        .filters-header {
            padding: 1.5rem;
            border-bottom: 1px solid #e5e7eb;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .filters-title {
            font-size: 1.25rem;
            font-weight: 700;
            color: #1f2937;
        }

        .filters-close {
            background: none;
            border: none;
            font-size: 1.5rem;
            cursor: pointer;
            color: #6b7280;
            padding: 0.25rem;
            border-radius: 4px;
            transition: all 0.2s ease;
        }

        .filters-close:hover {
            background: #f3f4f6;
            color: #374151;
        }

        .filters-content {
            flex: 1;
            padding: 1.5rem;
            overflow-y: auto;
        }

        .filter-group {
            margin-bottom: 2rem;
        }

        .filter-group h4 {
            font-size: 1rem;
            font-weight: 600;
            color: #1f2937;
            margin-bottom: 0.75rem;
        }

        .checkbox-item {
            display: flex;
            align-items: center;
            padding: 0.5rem;
            margin-bottom: 0.25rem;
            border-radius: 6px;
            transition: background-color 0.2s ease;
            cursor: pointer;
        }

        .checkbox-item:hover {
            background: #f9fafb;
        }

        .checkbox-item input[type="checkbox"] {
            width: 16px;
            height: 16px;
            margin-right: 0.75rem;
            accent-color: #3b82f6;
        }

        .checkbox-item label {
            font-size: 0.875rem;
            color: #374151;
            cursor: pointer;
            flex: 1;
        }

        .filters-actions {
            padding: 1rem 1.5rem;
            border-top: 1px solid #e5e7eb;
            background: #f9fafb;
        }

        .clear-filters-btn {
            width: 100%;
            background: #6b7280;
            color: white;
            border: none;
            padding: 0.75rem;
            border-radius: 6px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .clear-filters-btn:hover {
            background: #4b5563;
        }
        
        .secrets-table-container {
            flex: 1;
            overflow-y: auto;
        }
        
        .secrets-table {
            width: 100%;
            border-collapse: collapse;
            background: #ffffff;
        }
        
        .table-header {
            background: #f8fafc;
            border-bottom: 2px solid #e5e7eb;
            position: sticky;
            top: 0;
            z-index: 10;
        }
        
        .table-header th {
            padding: 0.75rem 1rem;
            text-align: left;
            font-weight: 600;
            color: #374151;
            font-size: 0.875rem;
            border-right: 1px solid #e5e7eb;
            cursor: pointer;
            user-select: none;
            transition: background-color 0.2s ease;
        }

        .table-header th:hover {
            background: #f1f5f9;
        }

        .table-header th.sortable::after {
            content: '‚Üì';
            margin-left: 0.5rem;
            opacity: 0.3;
            font-size: 0.75rem;
        }

        .table-header th.sortable.sort-asc::after {
            content: '‚Üë';
            opacity: 1;
            color: #3b82f6;
            font-weight: bold;
        }

        .table-header th.sortable.sort-desc::after {
            content: '‚Üì';
            opacity: 1;
            color: #3b82f6;
            font-weight: bold;
        }
        
        .table-header th:nth-child(1) { width: 28%; } /* Secret */
        .table-header th:nth-child(2) { width: 16%; } /* File */
        .table-header th:nth-child(3) { width: 10%; } /* Type */
        .table-header th:nth-child(4) { width: 10%; } /* Severity */
        .table-header th:nth-child(5) { width: 14%; } /* Resolved */
        .table-header th:nth-child(6) { width: 22%; } /* –ò—Å—Ç–æ—Ä–∏—è */
        
        .secret-row {
            border-bottom: 1px solid #f3f4f6;
            cursor: pointer;
            transition: all 0.2s ease;
        }
        
        .secret-row:hover {
            background: #f8fafc;
        }
        
        .secret-row.selected {
            background: #eff6ff;
            border-left: 4px solid #3b82f6;
            box-shadow: none;
        }
        
        .secret-row td {
            padding: 0.75rem 1rem;
            vertical-align: top;
            border-right: 1px solid #f3f4f6;
            font-size: 0.875rem;
        }
        
        .secret-value {
            font-weight: 600;
            color: #1f2937;
            font-size: 0.75rem;
            font-family: monospace;
            background: #f9fafb;
            padding: 0.25rem 0.5rem;
            border-radius: 4px;
            border: 1px solid #e5e7eb;
            max-width: 250px;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }
        
        .secret-file {
            font-family: monospace;
            color: #6b7280;
            font-size: 0.8rem;
            font-weight: 500;
        }
        
        .secret-line {
            font-size: 0.7rem;
            color: #9ca3af;
            margin-top: 0.25rem;
        }
        
        .secret-type {
            background: #f3f4f6;
            padding: 0.25rem 0.5rem;
            border-radius: 4px;
            font-size: 0.75rem;
            font-weight: 500;
            color: #374151;
            display: inline-block;
        }
        
        .secret-severity {
            padding: 0.25rem 0.5rem;
            border-radius: 12px;
            font-size: 0.75rem;
            font-weight: 600;
            text-transform: uppercase;
            display: inline-block;
        }
        
        .secret-severity.high {
            background: #fef2f2;
            color: #dc2626;
            border: 1px solid #fecaca;
        }
        
        .secret-severity.potential {
            background: #f9fafb;
            color: #6b7280;
            border: 1px solid #e5e7eb;
        }
        
        .resolved-status {
            text-align: center;
            font-size: 1.2rem;
            font-weight: 600;
        }
        
        .resolved-yes {
            color: #059669;
        }
        
        .resolved-no {
            color: #dc2626;
        }
        
        .scan-info {
            font-size: 0.8rem;
        }
        
        .scan-id {
            font-weight: 600;
            color: #059669;
            margin-bottom: 0.25rem;
        }
        
        .commit-hash {
            font-family: monospace;
            color: #6b7280;
            background: #f3f4f6;
            padding: 0.125rem 0.25rem;
            border-radius: 3px;
            font-size: 0.7rem;
        }
        
        .detail-panel {
            flex: 1;
            padding: 2rem;
            overflow-y: auto;
            background: #ffffff;
        }
        
        .detail-empty {
            text-align: center;
            color: #6b7280;
            padding: 4rem 2rem;
        }
        
        .detail-content h3 {
            margin-bottom: 1.5rem;
            color: #1f2937;
            font-size: 1.5rem;
            font-weight: 700;
        }
        
        .detail-section {
            margin-bottom: 2rem;
        }
        
        .detail-section h4 {
            margin-bottom: 0.75rem;
            color: #1f2937;
            font-size: 1rem;
            font-weight: 600;
        }
        
        .detail-field {
            background: #f9fafb;
            padding: 1rem;
            border-radius: 8px;
            margin-bottom: 0;
            font-family: monospace;
            font-size: 0.875rem;
            border: 1px solid #e5e7eb;
            word-wrap: break-word;
            display: block;
            width: 100%;
        }
        
        .detail-field.clickable {
            cursor: pointer;
            color: #059669;
            font-weight: 500;
            transition: all 0.2s ease;
        }
        
        .detail-field.clickable:hover {
            background: #ecfdf5;
            border-color: #10b981;
        }
        
        .empty-results {
            text-align: center;
            padding: 4rem;
            color: #6b7280;
        }

        /* PAGINATION */
        .pagination-container {
            padding: 1rem 2rem;
            border-top: 1px solid #e5e7eb;
            background: #ffffff;
            display: flex;
            justify-content: space-between;
            align-items: center;
            gap: 1rem;
        }

        .pagination-info {
            font-size: 0.875rem;
            color: #6b7280;
            flex: 1;
        }

        .pagination-controls {
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .pagination-btn {
            padding: 0.5rem 0.75rem;
            border: 1px solid #e5e7eb;
            background: #ffffff;
            color: #374151;
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.875rem;
            transition: all 0.2s ease;
            text-decoration: none;
        }

        .pagination-btn:hover:not(.disabled) {
            background: #f9fafb;
            border-color: #d1d5db;
        }

        .pagination-btn.active {
            background: #3b82f6;
            color: white;
            border-color: #3b82f6;
        }

        .pagination-btn.disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .page-size-selector {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            font-size: 0.875rem;
            color: #6b7280;
        }

        .page-size-selector select {
            padding: 0.25rem 0.5rem;
            border: 1px solid #e5e7eb;
            border-radius: 4px;
            font-size: 0.875rem;
        }

        /* Timeline styles */
        .timeline-container {
            background: #ffffff;
            border-radius: 12px;
            border: 1px solid #e5e7eb;
            padding: 1.5rem;
            position: relative;
            max-height: 600px;
            overflow-y: auto;
        }
        
        .timeline {
            position: relative;
            padding-left: 2rem;
        }
        
        .timeline::before {
            content: '';
            position: absolute;
            left: 0.75rem;
            top: 0;
            bottom: 0;
            width: 4px;
            background: linear-gradient(to bottom, #3b82f6, #06b6d4, #0ea5e9);
            border-radius: 2px;
        }
        
        .timeline-item {
            position: relative;
            margin-bottom: 2rem;
            background: #ffffff;
            border: 1px solid #e5e7eb;
            border-radius: 8px;
            padding: 1rem;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
            transition: all 0.3s ease;
            margin-left: 1rem;
        }
        
        .timeline-item:hover {
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
            transform: translateX(4px);
        }
        
        .timeline-item::before {
            content: '';
            position: absolute;
            left: -1.75rem;
            top: 1rem;
            width: 16px;
            height: 16px;
            border-radius: 50%;
            border: 3px solid #ffffff;
            z-index: 2;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
        }
        
        .timeline-item.status-confirmed::before {
            background: #dc2626;
        }
        
        .timeline-item.status-refuted::before {
            background: #10b981;
        }
        
        .timeline-item.status-not-found::before {
            background: #9ca3af;
        }
        
        .timeline-status.not-found {
            background: #f3f4f6;
            color: #6b7280;
            border: 1px solid #d1d5db;
        }
        
        .timeline-date-badge {
            position: absolute;
            left: -1.75rem;
            top: -0.5rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
            min-width: 4rem;
            z-index: 3;
        }
        
        .timeline-date-external {
            background: #e0f2fe;
            color: #0f172a;
            border: 1px solid #7dd3fc;
            padding: 0.25rem 0.5rem;
            border-radius: 8px;
            font-size: 0.65rem;
            font-weight: 500;
            white-space: nowrap;
        }
        
        .timeline-user-external {
            background: #1e40af;
            color: #ffffff;
            padding: 0.25rem 0.4rem;
            border-radius: 6px;
            font-size: 0.6rem;
            font-weight: 600;
            white-space: nowrap;
        }
        
        .timeline-header {
            display: flex;
            justify-content: flex-end;
            align-items: center;
            margin-bottom: 0.5rem;
        }
        
        .timeline-status {
            padding: 0.2rem 0.6rem;
            border-radius: 16px;
            font-size: 0.7rem;
            font-weight: 600;
            text-transform: uppercase;
        }
        
        .timeline-status.confirmed {
            background: #fee2e2;
            color: #dc2626;
            border: 1px solid #fecaca;
        }
        
        .timeline-status.refuted {
            background: #d1fae5;
            color: #065f46;
            border: 1px solid #a7f3d0;
        }
        
        .timeline-status.no-status {
            background: #f3f4f6;
            color: #6b7280;
            border: 1px solid #d1d5db;
        }
        
        .timeline-content {
            font-size: 0.8rem;
            color: #374151;
        }
        
        .timeline-secret {
            font-family: monospace;
            background: #f8fafc;
            padding: 0.4rem 0.6rem;
            border-radius: 4px;
            margin: 0.3rem 0;
            border: 1px solid #e2e8f0;
            font-size: 0.75rem;
        }
        
        .timeline-commit {
            font-family: monospace;
            font-size: 0.75rem;
            color: #6b7280;
            margin: 0.25rem 0;
        }
        
        .timeline-comment {
            background: #fef3c7;
            padding: 0.5rem;
            border-radius: 6px;
            font-size: 0.75rem;
            color: #92400e;
            border-left: 3px solid #f59e0b;
            margin-top: 0.5rem;
        }
        
        .timeline-actions {
            display: flex;
            gap: 0.5rem;
            margin-top: 0.5rem;
        }
        
        .timeline-btn {
            padding: 0.25rem 0.5rem;
            border-radius: 4px;
            font-size: 0.7rem;
            text-decoration: none;
            border: 1px solid;
            transition: all 0.2s ease;
            display: inline-flex;
            align-items: center;
            gap: 0.25rem;
        }
        
        .timeline-btn.scan {
            background: #eff6ff;
            color: #2563eb;
            border-color: #3b82f6;
        }
        
        .timeline-btn.scan:hover {
            background: #dbeafe;
        }
        
        .timeline-btn.compare {
            background: #f0fdf4;
            color: #166534;
            border-color: #16a34a;
        }
        
        .timeline-btn.compare:hover {
            background: #dcfce7;
        }
        
        .resolution-banner {
            background: linear-gradient(135deg, #d1fae5 0%, #a7f3d0 100%);
            border: 1px solid #6ee7b7;
            border-radius: 8px;
            padding: 1rem;
            margin-bottom: 1.5rem;
            display: flex;
            align-items: center;
            gap: 0.75rem;
        }
        
        .resolution-banner.refuted {
            background: linear-gradient(135deg, #d1fae5 0%, #a7f3d0 100%);
            border-color: #10b981;
        }
        
        .resolution-banner .icon {
            font-size: 1.5rem;
        }
        
        .resolution-banner .text {
            font-weight: 500;
            color: #065f46;
        }
        
        .resolution-banner.refuted .text {
            color: #065f46;
        }

        .status-refuted {
            color: #059669;
        }

        .status-resolved {
            color: #f59e0b;
        }

        .status-active {
            color: #dc2626;
        }
    </style>
</head>
<body>
    <script type="application/json" id="secrets-data">{{ secrets_json | safe }}</script>
    <script type="application/json" id="secrets-all-data">{{ secrets_all_json | safe }}</script>
    
    <header class="header">
        <a href="/secret_scanner/dashboard" class="logo">
            üîç Secrets Scanner
        </a>
        <nav class="nav-links">
            <a href="/secret_scanner/dashboard">üåê –ì–ª–∞–≤–Ω–∞—è</a>
            <a href="/secret_scanner/multi-scan">üîÑ –ú—É–ª—å—Ç–∏—Å–∫–∞–Ω</a>
            {% if current_user == "admin" %}
            <a href="/secret_scanner/admin">üëë –ê–¥–º–∏–Ω –ø–∞–Ω–µ–ª—å</a>
            {% endif %}
            <a href="/secret_scanner/settings">‚öôÔ∏è –ù–∞—Å—Ç—Ä–æ–π–∫–∏</a>
            <a href="/secret_scanner/logout">üîö –í—ã–π—Ç–∏</a>
        </nav>
    </header>
    
    <div class="main-content">
        <div class="left-panel">
            <div class="panel-header">
                <h1 class="project-title">üìã –ò—Å—Ç–æ—Ä–∏—è —Å–µ–∫—Ä–µ—Ç–æ–≤: {{ project.name }}</h1>
                
                {% if latest_scan %}
                <div style="margin-bottom: 1rem;">
                    <a href="{{ project.repo_url }}" target="_blank" class="repo-link">
                        üîó {{ project.repo_url }}
                    </a>
                    <br>
                    <span class="commit-info">
                        ‚öôÔ∏è –ê–∫—Ç—É–∞–ª—å–Ω—ã–π –∫–æ–º–º–∏—Ç: <span style="font-weight: bold; color: #3b82f6;">{{ latest_scan.repo_commit if latest_scan.repo_commit else 'Unknown' }}</span>
                    </span>
                </div>
                {% endif %}
                
                <div style="color: #6b7280; font-size: 0.875rem; margin-bottom: 1rem;">
                    üìä –ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–Ω—ã–µ —Å–µ–∫—Ä–µ—Ç—ã –∑–∞ –≤—Å–µ –≤—Ä–µ–º—è
                </div>
                
                <div class="stats-summary">
                    <div class="stat-item">
                        <div class="stat-number" id="filteredCount">{{ total_confirmed }}</div>
                        <div class="stat-label">–ü–æ–∫–∞–∑–∞–Ω–æ</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-number" id="totalCount">{{ total_all }}</div>
                        <div class="stat-label">–í—Å–µ–≥–æ –∑–∞–ø–∏—Å–µ–π</div>
                    </div>
                </div>
                
                <div class="actions-row">
                    <div class="left-actions">
                        <a href="/secret_scanner/project/{{ project.name }}" class="btn btn-secondary">‚Üê –ù–∞–∑–∞–¥</a>
                        <input type="text" id="searchInput" class="search-input" placeholder="üîç –ü–æ–∏—Å–∫..." oninput="applyFilters()">
                        <label style="display: flex; align-items: center; gap: 0.5rem; font-size: 0.875rem; color: #6b7280;">
                            <input type="checkbox" id="showAllSecrets" onchange="applyFilters()" style="margin: 0;">
                            –ü–æ–∫–∞–∑–∞—Ç—å –Ω–µ–ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–Ω—ã–µ
                        </label>
                    </div>
                    <div class="right-actions">
                        <button class="btn btn-info" onclick="toggleFiltersPanel()" id="filtersToggleBtn">üîç –§–∏–ª—å—Ç—Ä—ã</button>
                    </div>
                </div>
            </div>

            <div class="secrets-table-container" id="secretsTableContainer">
                <div id="secretsTable">
                    <!-- Table will be populated by JavaScript -->
                </div>
            </div>

            <div class="pagination-container" id="paginationContainer">
                <div class="pagination-info" id="paginationInfo">
                    <!-- Pagination info will be populated by JavaScript -->
                </div>
                <div class="pagination-controls" id="paginationControls">
                    <!-- Pagination controls will be populated by JavaScript -->
                </div>
                <div class="page-size-selector">
                    <label for="pageSize">–ó–∞–ø–∏—Å–µ–π –Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü—É:</label>
                    <select id="pageSize" onchange="changePageSize()">
                        <option value="50">50</option>
                        <option value="100" selected>100</option>
                        <option value="200">200</option>
                        <option value="500">500</option>
                    </select>
                </div>
            </div>
        </div>
        
        <div class="right-panel">
            <div class="panel-header">
                <h3>–î–µ—Ç–∞–ª–∏ —Å–µ–∫—Ä–µ—Ç–∞</h3>
            </div>
            <div class="detail-panel" id="detailPanel">
                <div class="detail-empty">
                    <div style="font-size: 3rem; margin-bottom: 1rem;">üëà</div>
                    <h3>–í—ã–±–µ—Ä–∏—Ç–µ —Å–µ–∫—Ä–µ—Ç</h3>
                    <p>–ö–ª–∏–∫–Ω–∏—Ç–µ –Ω–∞ –ª—é–±–æ–π —Å–µ–∫—Ä–µ—Ç –∏–∑ —Å–ø–∏—Å–∫–∞ –¥–ª—è –ø—Ä–æ—Å–º–æ—Ç—Ä–∞ –ø–æ–¥—Ä–æ–±–Ω–æ–π –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏.</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Filters Panel -->
    <div class="filters-panel" id="filtersPanel">
        <div class="filters-header">
            <h3 class="filters-title">üîç –§–∏–ª—å—Ç—Ä—ã</h3>
            <button class="filters-close" onclick="toggleFiltersPanel()">√ó</button>
        </div>
        <div class="filters-content">
            <div class="filter-group">
                <h4>üìä –°—Ç–∞—Ç—É—Å</h4>
                <div class="checkbox-item">
                    <input type="checkbox" id="status-refuted" value="refuted" onchange="applyFilters()" checked>
                    <label for="status-refuted">‚úÖ Refuted</label>
                </div>
                <div class="checkbox-item">
                    <input type="checkbox" id="status-resolved" value="resolved" onchange="applyFilters()" checked>
                    <label for="status-resolved">‚ö†Ô∏è Resolved</label>
                </div>
                <div class="checkbox-item">
                    <input type="checkbox" id="status-active" value="active" onchange="applyFilters()" checked>
                    <label for="status-active">‚ùå Active</label>
                </div>
            </div>

            <div class="filter-group">
                <h4>‚ö†Ô∏è –£—Ä–æ–≤–µ–Ω—å</h4>
                <div class="checkbox-item">
                    <input type="checkbox" id="severity-high" value="High" onchange="applyFilters()" checked>
                    <label for="severity-high">üõë High</label>
                </div>
                <div class="checkbox-item">
                    <input type="checkbox" id="severity-potential" value="Potential" onchange="applyFilters()" checked>
                    <label for="severity-potential">üîò Potential</label>
                </div>
            </div>

            <div class="filter-group">
                <h4>üè∑Ô∏è –¢–∏–ø</h4>
                <div id="typeFilters">
                    <!-- Type filters will be populated by JavaScript -->
                </div>
            </div>
        </div>
        <div class="filters-actions">
            <button class="clear-filters-btn" onclick="clearAllFilters()">–û—á–∏—Å—Ç–∏—Ç—å –≤—Å–µ —Ñ–∏–ª—å—Ç—Ä—ã</button>
        </div>
    </div>

    <script>
        // Global variables
        let allSecrets = [];
        let allSecretsData = [];
        let filteredSecrets = [];
        let currentPage = 1;
        let pageSize = 100;
        let isFiltersOpen = false;
        let sortColumns = [];
        let selectedSecret = null;
        let activeFilters = {
            status: ['refuted', 'resolved', 'active'],
            severity: ['High', 'Potential'],
            type: [],
            search: ''
        };

        // Server-side data
        let projectRepoUrl = {{ project.repo_url | tojson | safe }};
        let latestCommit = {{ latest_scan.repo_commit | tojson | safe if latest_scan else 'null' }};
        let hubType = {{ hub_type | tojson | safe }};

        function escapeHtml(text) {
            if (text === null || text === undefined) {
                return '';
            }
            
            const str = String(text);
            const div = document.createElement('div');
            div.textContent = str;
            return div.innerHTML;
        }

        function safeHtml(text) {
            return escapeHtml(text);
        }

        // Load data from script tags
        function loadSecretsData() {
            try {
                const confirmedDataElement = document.getElementById('secrets-data');
                const allDataElement = document.getElementById('secrets-all-data');
                
                if (confirmedDataElement) {
                    const confirmedData = JSON.parse(confirmedDataElement.textContent);
                    console.log('Loaded confirmed secrets:', confirmedData.length);
                }
                
                if (allDataElement) {
                    allSecretsData = JSON.parse(allDataElement.textContent);
                    console.log('Loaded all secrets:', allSecretsData.length);
                }
                
                allSecrets = allSecretsData.slice();
                return true;
                
            } catch (error) {
                console.error('Error loading secrets data:', error);
                return false;
            }
        }

        function initializeFilters() {
            const uniqueTypes = [...new Set(allSecretsData.map(s => s.type))].sort();
            
            const typeFiltersContainer = document.getElementById('typeFilters');
            if (!typeFiltersContainer) {
                console.error('typeFilters container not found');
                return;
            }
            
            typeFiltersContainer.innerHTML = '';
            
            uniqueTypes.forEach(type => {
                const div = document.createElement('div');
                div.className = 'checkbox-item';
                const safeId = type.replace(/[^a-zA-Z0-9]/g, '_');
                div.innerHTML = `
                    <input type="checkbox" id="type-${safeId}" value="${safeHtml(type)}" onchange="applyFilters()" checked>
                    <label for="type-${safeId}">${safeHtml(type)}</label>
                `;
                typeFiltersContainer.appendChild(div);
            });

            activeFilters.type = uniqueTypes.slice();
        }

        function updateStatusFilters() {
            const filtersContent = document.querySelector('.filters-content');
            if (!filtersContent) return;
            
            // –ù–∞–π—Ç–∏ –∏ –∑–∞–º–µ–Ω–∏—Ç—å –±–ª–æ–∫ —Å—Ç–∞—Ç—É—Å–æ–≤
            const statusGroup = filtersContent.querySelector('.filter-group');
            if (statusGroup) {
                statusGroup.innerHTML = `
                    <h4>üìä –°—Ç–∞—Ç—É—Å</h4>
                    <div class="checkbox-item">
                        <input type="checkbox" id="status-refuted" value="refuted" onchange="applyFilters()" checked>
                        <label for="status-refuted">‚úÖ Refuted</label>
                    </div>
                    <div class="checkbox-item">
                        <input type="checkbox" id="status-resolved" value="resolved" onchange="applyFilters()" checked>
                        <label for="status-resolved">‚ö†Ô∏è Resolved</label>
                    </div>
                    <div class="checkbox-item">
                        <input type="checkbox" id="status-active" value="active" onchange="applyFilters()" checked>
                        <label for="status-active">‚ùå Active</label>
                    </div>
                `;
            }
        }

        function applyFilters() {
            console.log('Applying filters to', allSecrets.length, 'secrets');
            
            activeFilters.status = [];
            activeFilters.severity = [];
            activeFilters.type = [];
            activeFilters.search = document.getElementById('searchInput')?.value?.toLowerCase() || '';

            const showUnconfirmed = document.getElementById('showAllSecrets')?.checked || false;
            
            // Status filters
            if (document.getElementById('status-refuted')?.checked) {
                activeFilters.status.push('refuted');
            }
            if (document.getElementById('status-resolved')?.checked) {
                activeFilters.status.push('resolved');
            }
            if (document.getElementById('status-active')?.checked) {
                activeFilters.status.push('active');
            }

            // Severity filters
            if (document.getElementById('severity-high')?.checked) {
                activeFilters.severity.push('High');
            }
            if (document.getElementById('severity-potential')?.checked) {
                activeFilters.severity.push('Potential');
            }

            // Type filters
            document.querySelectorAll('#typeFilters input[type="checkbox"]:checked').forEach(cb => {
                activeFilters.type.push(cb.value);
            });

            console.log('Active filters:', activeFilters);

            filteredSecrets = allSecrets.filter(secret => {
                // Search filter
                if (activeFilters.search && !secret.current_secret.toLowerCase().includes(activeFilters.search)) {
                    return false;
                }

                // Show unconfirmed checkbox
                if (!showUnconfirmed && !secret.has_confirmed) {
                    return false;
                }

                // Status filter - –ø—Ä–æ–≤–µ—Ä—è–µ–º —á—Ç–æ —Å—Ç–∞—Ç—É—Å —Å—É—â–µ—Å—Ç–≤—É–µ—Ç
                if (secret.status && !activeFilters.status.includes(secret.status)) {
                    return false;
                }

                // Severity filter
                if (!activeFilters.severity.includes(secret.severity)) {
                    return false;
                }

                // Type filter
                if (!activeFilters.type.includes(secret.type)) {
                    return false;
                }

                return true;
            });

            console.log('Filtered secrets:', filteredSecrets.length);

            currentPage = 1;
            selectedSecret = null;
            showEmptyDetail();
            sortSecrets();
            updateStats();
            renderTable();
            renderPagination();
            updateURL();
        }

        function clearAllFilters() {
            document.querySelectorAll('#filtersPanel input[type="checkbox"]').forEach(cb => {
                cb.checked = true;
            });
            
            const searchInput = document.getElementById('searchInput');
            if (searchInput) {
                searchInput.value = '';
            }
            
            applyFilters();
        }

        function updateStats() {
            const totalCount = allSecrets.length;
            const filteredCount = filteredSecrets.length;

            const totalEl = document.getElementById('totalCount');
            const filteredEl = document.getElementById('filteredCount');
            
            if (totalEl) totalEl.textContent = totalCount;
            if (filteredEl) filteredEl.textContent = filteredCount;
        }

        function updateURL() {
            const params = new URLSearchParams();
            params.set('page', currentPage);
            params.set('page_size', pageSize);
            
            const newURL = window.location.pathname + '?' + params.toString();
            history.replaceState(null, '', newURL);
        }

        function renderTable() {
            const tableContainer = document.getElementById('secretsTable');
            
            if (filteredSecrets.length === 0) {
                tableContainer.innerHTML = `
                    <div class="empty-results">
                        <h3>üì≠ –ù–µ—Ç —Å–µ–∫—Ä–µ—Ç–æ–≤</h3>
                        <p>–ù–µ—Ç —Å–µ–∫—Ä–µ—Ç–æ–≤, —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É—é—â–∏—Ö —Ç–µ–∫—É—â–∏–º —Ñ–∏–ª—å—Ç—Ä–∞–º.</p>
                    </div>
                `;
                return;
            }

            const startIndex = (currentPage - 1) * pageSize;
            const endIndex = Math.min(startIndex + pageSize, filteredSecrets.length);
            const pageSecrets = filteredSecrets.slice(startIndex, endIndex);

            let tableHTML = `
                <table class="secrets-table">
                    <thead class="table-header">
                        <tr>
                            <th class="sortable" data-sort="secret">üîë Secret</th>
                            <th class="sortable" data-sort="file">üìÅ File</th>
                            <th class="sortable" data-sort="type">üè∑Ô∏è Type</th>
                            <th class="sortable" data-sort="severity">‚ö†Ô∏è Severity</th>
                            <th class="sortable" data-sort="status">üìä Status</th>
                            <th class="sortable" data-sort="history">üìä –ò—Å—Ç–æ—Ä–∏—è</th>
                        </tr>
                    </thead>
                    <tbody>
            `;

            pageSecrets.forEach((secret, index) => {
                const globalIndex = startIndex + index;
                
                // –û–ø—Ä–µ–¥–µ–ª—è–µ–º –∏–∫–æ–Ω–∫—É –∏ –∫–ª–∞—Å—Å —Å—Ç–∞—Ç—É—Å–∞
                let statusIcon = '‚ùå';
                let statusClass = 'active';
                
                if (secret.status === 'refuted') {
                    statusIcon = '‚úÖ';
                    statusClass = 'refuted';
                } else if (secret.status === 'resolved') {
                    statusIcon = '‚ö†Ô∏è';
                    statusClass = 'resolved';
                } else if (secret.status === 'active') {
                    statusIcon = '‚ùå';
                    statusClass = 'active';
                }
                
                tableHTML += `
                    <tr class="secret-row" data-secret-id="${secret.id}" data-secret-index="${globalIndex}">
                        <td>
                            <div class="secret-value">${safeHtml(secret.current_secret)}</div>
                        </td>
                        <td>
                            <div class="secret-file">${safeHtml((secret.path || '').split('/').pop())}</div>
                            <div class="secret-line">Line ${secret.line}</div>
                        </td>
                        <td>
                            <div class="secret-type">${safeHtml(secret.type)}</div>
                        </td>
                        <td>
                            <div class="secret-severity ${(secret.severity || '').toLowerCase()}">${safeHtml(secret.severity)}</div>
                        </td>
                        <td>
                            <div class="resolved-status status-${statusClass}">
                                ${statusIcon}
                            </div>
                        </td>
                        <td>
                            <div class="scan-info">
                                <div class="scan-id">${(secret.unique_commits || []).length} –∫–æ–º–º–∏—Ç${(secret.unique_commits || []).length !== 1 ? '–æ–≤' : ''}</div>
                            </div>
                        </td>
                    </tr>
                `;
            });

            tableHTML += '</tbody></table>';
            tableContainer.innerHTML = tableHTML;

            initializeTableEventListeners();
        }

        function initializeTableEventListeners() {
            const secretRows = document.querySelectorAll('.secret-row');
            secretRows.forEach((row, index) => {
                row.addEventListener('click', function(e) {
                    const secretId = parseInt(row.dataset.secretId);
                    const globalIndex = parseInt(row.dataset.secretIndex);
                    selectSecret(secretId);
                });
            });

            const sortableHeaders = document.querySelectorAll('.sortable');
            sortableHeaders.forEach(header => {
                header.addEventListener('click', function() {
                    const column = this.dataset.sort;
                    handleSort(column);
                });
            });
        }

        function selectSecret(secretId) {
            document.querySelectorAll('.secret-row').forEach(row => {
                row.classList.remove('selected');
            });
            
            const row = document.querySelector(`[data-secret-id="${secretId}"]`);
            if (row) {
                row.classList.add('selected');
                selectedSecret = secretId;
                showSecretDetails(secretId);
            }
        }

        function showEmptyDetail() {
            const detailPanel = document.getElementById('detailPanel');
            if (!detailPanel) return;
            
            detailPanel.innerHTML = `
                <div class="detail-empty">
                    <div style="font-size: 3rem; margin-bottom: 1rem;">üëà</div>
                    <h3>–í—ã–±–µ—Ä–∏—Ç–µ —Å–µ–∫—Ä–µ—Ç</h3>
                    <p>–ö–ª–∏–∫–Ω–∏—Ç–µ –Ω–∞ –ª—é–±–æ–π —Å–µ–∫—Ä–µ—Ç –∏–∑ —Å–ø–∏—Å–∫–∞ –¥–ª—è –ø—Ä–æ—Å–º–æ—Ç—Ä–∞ –ø–æ–¥—Ä–æ–±–Ω–æ–π –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏.</p>
                </div>
            `;
        }

        function showSecretDetails(secretId) {
            const secret = allSecrets.find(s => s.id === secretId);
            if (!secret) return;
            
            let fileUrl = '#';
            try {
                if (projectRepoUrl && projectRepoUrl.includes('devzone.local')) {
                    fileUrl = `${projectRepoUrl}/-/blob/${latestCommit || 'main'}/${encodeURIComponent(secret.path)}#L${secret.line}-${secret.line}`;
                } else if (hubType === 'Azure') {
                    const startColumn = 1;
                    const secretLength = secret.current_secret ? secret.current_secret.length : 0;
                    const endColumn = secretLength + 1;
                    fileUrl = `${projectRepoUrl}?path=${encodeURIComponent(secret.path)}&version=GC${latestCommit || 'main'}&line=${secret.line}&lineEnd=${secret.line}&lineStartColumn=${startColumn}&lineEndColumn=${endColumn}&_a=contents`;
                } else if (projectRepoUrl) {
                    const safePath = secret.path.split('/').map(encodeURIComponent).join('/');
                    fileUrl = `${projectRepoUrl}/blob/${latestCommit || 'main'}${safePath}?plain=1#L${secret.line}`;
                }
            } catch (error) {
                console.error('Error building file URL:', error);
            }

            // Filter timeline to show only scans AFTER first detection
            let filteredTimeline = [];
            if (secret.timeline && secret.timeline.length > 0) {
                const sortedTimeline = secret.timeline.slice().sort((a, b) => 
                    new Date(a.scan_date) - new Date(b.scan_date)
                );
                
                const firstDetectionIndex = sortedTimeline.findIndex(item => item.found_secret);
                
                if (firstDetectionIndex !== -1) {
                    filteredTimeline = sortedTimeline.slice(firstDetectionIndex);
                } else {
                    filteredTimeline = sortedTimeline;
                }
            }

            let timelineHtml = '';
            if (filteredTimeline && filteredTimeline.length > 0) {
                timelineHtml = filteredTimeline.map((item, index) => {
                    const date = new Date(item.scan_date).toLocaleString('ru-RU');
                    const statusClass = item.status.toLowerCase().replace(' ', '-');
                    
                    let statusDisplay = '';
                    let userInfo = '';
                    let commentHtml = '';
                    
                    if (item.status === 'Confirmed') {
                        statusDisplay = '–ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω';
                        if (item.confirmed_by) {
                            userInfo = `üë§ ${safeHtml(item.confirmed_by)}`;
                        }
                    } else if (item.status === 'Refuted') {
                        statusDisplay = '–í –∏—Å–∫–ª—é—á–µ–Ω–∏—è—Ö';
                        if (item.refuted_by) {
                            userInfo = `üë§ ${safeHtml(item.refuted_by)}`;
                        }
                        if (item.exception_comment) {
                            commentHtml = `<div class="timeline-comment">üí¨ ${safeHtml(item.exception_comment)}</div>`;
                        }
                    } else if (item.status === 'Not Found') {
                        statusDisplay = '–ù–µ –Ω–∞–π–¥–µ–Ω';
                    } else {
                        statusDisplay = '–û–±–Ω–∞—Ä—É–∂–µ–Ω';
                    }
                    
                    let actionsHtml = '';
                    const scanBtn = `<a href="/secret_scanner/scan/${item.scan_id}/results" target="_blank" class="timeline-btn scan">üìä –°–∫–∞–Ω</a>`;
                    
                    let compareBtn = '';
                    if (latestCommit && item.commit && item.commit !== latestCommit) {
                        let compareUrl = '#';
                        try {
                            if (hubType === 'Azure') {
                                const urlParts = projectRepoUrl.split('/');
                                if (urlParts.length >= 6) {
                                    const org = urlParts[3];
                                    const project = urlParts[4];
                                    const repo = urlParts[6];
                                    compareUrl = `https://dev.azure.com/${org}/${project}/_git/${repo}/compare/commit/${item.commit}...${latestCommit}?path=${encodeURIComponent(secret.path)}`;
                                }
                            } else if (projectRepoUrl && projectRepoUrl.includes('github.com')) {
                                compareUrl = `${projectRepoUrl}/compare/${item.commit}...${latestCommit}`;
                            }
                        } catch (error) {
                            console.error('Error building compare URL:', error);
                        }
                        
                        if (compareUrl !== '#') {
                            compareBtn = `<a href="${compareUrl}" target="_blank" class="timeline-btn compare">üîó –°—Ä–∞–≤–Ω–∏—Ç—å —Å —Ç–µ–∫—É—â–∏–º</a>`;
                        }
                    }
                    
                    actionsHtml = `<div class="timeline-actions">${scanBtn}${compareBtn}</div>`;
                    
                    let contentHtml = '';
                    if (item.found_secret) {
                        contentHtml = `
                            <div class="timeline-content">
                                <div class="timeline-secret">üîë ${safeHtml(item.secret_value)}</div>
                                <div class="timeline-commit">üîó ${safeHtml(item.commit || 'unknown')}</div>
                            </div>
                        `;
                    } else {
                        contentHtml = `
                            <div class="timeline-content">
                                <div class="timeline-secret" style="color: #9ca3af; font-style: italic;">üîç –°–µ–∫—Ä–µ—Ç –Ω–µ –æ–±–Ω–∞—Ä—É–∂–µ–Ω –≤ —ç—Ç–æ–º —Å–∫–∞–Ω–µ</div>
                                <div class="timeline-commit">üîó ${safeHtml(item.commit || 'unknown')}</div>
                                <div style="font-size: 0.75rem; color: #f59e0b; margin-top: 0.5rem; padding: 0.5rem; background: #fef3c7; border-radius: 4px; border-left: 3px solid #f59e0b;">
                                    ‚ö†Ô∏è <strong>–í–æ–∑–º–æ–∂–Ω–æ–µ –ø–µ—Ä–µ–∏–º–µ–Ω–æ–≤–∞–Ω–∏–µ:</strong> –°–µ–∫—Ä–µ—Ç –º–æ–≥ –±—ã—Ç—å –ø–µ—Ä–µ–∏–º–µ–Ω–æ–≤–∞–Ω (–Ω–∞–ø—Ä–∏–º–µ—Ä, SECRET ‚Üí VARIABLE), –Ω–æ –∑–Ω–∞—á–µ–Ω–∏–µ –æ—Å—Ç–∞–ª–æ—Å—å —Ç–µ–º –∂–µ.
                                </div>
                            </div>
                        `;
                    }
                    
                    return `
                        <div class="timeline-item status-${statusClass}">
                            <div class="timeline-date-badge">
                                <div class="timeline-date-external">üìÖ ${date}</div>
                                ${userInfo ? `<div class="timeline-user-external">${userInfo}</div>` : ''}
                            </div>
                            <div class="timeline-header">
                                <div class="timeline-status ${statusClass}">${statusDisplay}</div>
                            </div>
                            ${contentHtml}
                            ${commentHtml}
                            ${actionsHtml}
                        </div>
                    `;
                }).join('');
            }
            
            let resolutionBanner = '';
            if (secret.status === 'refuted') {
                resolutionBanner = `
                    <div class="resolution-banner refuted">
                        <div class="icon">üõ°Ô∏è</div>
                        <div class="text">
                            <strong>–í –∏—Å–∫–ª—é—á–µ–Ω–∏—è—Ö:</strong> –î–∞–Ω–Ω—ã–π —Å–µ–∫—Ä–µ—Ç –±—ã–ª –ø—Ä–æ–∞–Ω–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω –∏ –¥–æ–±–∞–≤–ª–µ–Ω –≤ –∏—Å–∫–ª—é—á–µ–Ω–∏—è –∫–∞–∫ –ª–æ–∂–Ω–æ–µ —Å—Ä–∞–±–∞—Ç—ã–≤–∞–Ω–∏–µ –∏–ª–∏ –æ–±–æ—Å–Ω–æ–≤–∞–Ω–Ω–æ–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ. 
                            <br><small><strong>–ü—Ä–∏–º–µ—Ä:</strong> –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–æ–Ω–Ω—ã–π –ø–∞—Ä–∞–º–µ—Ç—Ä, —Ç–µ—Å—Ç–æ–≤—ã–µ –¥–∞–Ω–Ω—ã–µ, –ø—É–±–ª–∏—á–Ω—ã–π –∫–ª—é—á</small>
                        </div>
                    </div>
                `;
            } else if (secret.status === 'resolved') {
                resolutionBanner = `
                    <div class="resolution-banner">
                        <div class="icon">‚ö†Ô∏è</div>
                        <div class="text">
                            <strong>–¢—Ä–µ–±—É–µ—Ç –≤–Ω–∏–º–∞–Ω–∏—è:</strong> –î–∞–Ω–Ω—ã–π —Å–µ–∫—Ä–µ—Ç –±—ã–ª –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω —Ä–∞–Ω–µ–µ, –Ω–æ –Ω–µ –æ–±–Ω–∞—Ä—É–∂–µ–Ω –≤ –ø–æ—Å–ª–µ–¥–Ω–∏—Ö —Å–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏—è—Ö. 
                            <br><small><strong>–í–æ–∑–º–æ–∂–Ω—ã–µ –ø—Ä–∏—á–∏–Ω—ã:</strong> —É–¥–∞–ª–µ–Ω —Ä–∞–∑—Ä–∞–±–æ—Ç—á–∏–∫–∞–º–∏, –ø–µ—Ä–µ–∏–º–µ–Ω–æ–≤–∞–Ω–∞ –ø–µ—Ä–µ–º–µ–Ω–Ω–∞—è, –∏–∑–º–µ–Ω–µ–Ω —Ñ–æ—Ä–º–∞—Ç</small>
                        </div>
                    </div>
                `;
            } else {
                resolutionBanner = `
                    <div style="background: #fee2e2; color: #991b1b; padding: 0.75rem; border-radius: 6px; margin-bottom: 1.5rem; border-left: 4px solid #dc2626;">
                        <strong>‚ùå –ê–∫—Ç–∏–≤–µ–Ω:</strong> –î–∞–Ω–Ω—ã–π —Å–µ–∫—Ä–µ—Ç –≤—Å–µ –µ—â–µ –ø—Ä–∏—Å—É—Ç—Å—Ç–≤—É–µ—Ç –≤ —Ç–µ–∫—É—â–µ–π –≤–µ—Ä—Å–∏–∏ –∫–æ–¥–∞ –∏ —Ç—Ä–µ–±—É–µ—Ç –≤–Ω–∏–º–∞–Ω–∏—è.
                        <br><small>–ù–µ–æ–±—Ö–æ–¥–∏–º–æ –ª–∏–±–æ —É–¥–∞–ª–∏—Ç—å —Å–µ–∫—Ä–µ—Ç, –ª–∏–±–æ –¥–æ–±–∞–≤–∏—Ç—å –≤ –∏—Å–∫–ª—é—á–µ–Ω–∏—è –µ—Å–ª–∏ —ç—Ç–æ –ª–æ–∂–Ω–æ–µ —Å—Ä–∞–±–∞—Ç—ã–≤–∞–Ω–∏–µ.</small>
                    </div>
                `;
            }
            
            const detailPanel = document.getElementById('detailPanel');
            if (!detailPanel) return;
            
            detailPanel.innerHTML = `
                <div class="detail-content">
                    ${resolutionBanner}
                    
                    <div class="detail-section">
                        <h4>üîë –ü–æ—Å–ª–µ–¥–Ω–µ–µ –≤—ã—è–≤–ª–µ–Ω–Ω–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ —Å–µ–∫—Ä–µ—Ç–∞</h4>
                        <div class="detail-field" style="background: #fef3c7; border: 1px solid #f59e0b; color: #92400e; font-weight: 600;">
                            ${safeHtml(secret.current_secret || '–ó–Ω–∞—á–µ–Ω–∏–µ –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–æ')}
                        </div>
                    </div>
                    
                    <div class="detail-section">
                        <h4>üìÅ –†–∞—Å–ø–æ–ª–æ–∂–µ–Ω–∏–µ</h4>
                        <div style="margin-bottom: 1rem;">
                            <a href="${fileUrl}" target="_blank" class="detail-field clickable" style="text-decoration: none; color: #059669;">
                                ${safeHtml(secret.path)}
                            </a>
                        </div>
                        <div style="margin-bottom: 1rem;">
                            <div class="detail-field">
                                <strong>–°—Ç—Ä–æ–∫–∞:</strong> ${secret.line}
                            </div>
                        </div>
                        <div style="font-size: 0.8rem; color: #666; padding: 0.5rem 0;">
                            üîó –ù–∞–∂–º–∏—Ç–µ —á—Ç–æ–±—ã –æ—Ç–∫—Ä—ã—Ç—å –≤ —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–∏ (—Å—Ç—Ä–æ–∫–∞ –≤—ã–¥–µ–ª—è–µ—Ç—Å—è –ø—Ä–∏ –æ—Ç–∫—Ä—ã—Ç–∏–∏)
                        </div>
                    </div>
                    
                    <div class="detail-section">
                        <h4>üìù –ü–æ—Å–ª–µ–¥–Ω–∏–π –∫–æ–Ω—Ç–µ–∫—Å—Ç</h4>
                        <div class="detail-field" style="white-space: pre-wrap;">
                            ${safeHtml(secret.current_context || '–ù–µ—Ç –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞')}
                        </div>
                    </div>
                    
                    <div class="detail-section">
                        <h4>üîÑ –ò—Å—Ç–æ—Ä–∏—è —Å–µ–∫—Ä–µ—Ç–∞ (—Å –º–æ–º–µ–Ω—Ç–∞ –ø–µ—Ä–≤–æ–≥–æ –æ–±–Ω–∞—Ä—É–∂–µ–Ω–∏—è)</h4>
                        <div class="timeline-container">
                            <div class="timeline">
                                ${timelineHtml || '<div style="text-align: center; color: #6b7280; padding: 2rem;">–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –æ –∏—Å—Ç–æ—Ä–∏–∏</div>'}
                            </div>
                        </div>
                    </div>
                    
                    <div class="detail-section">
                        <h4>üìä –°–≤–æ–¥–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è</h4>
                        <div class="detail-field">
                            <strong>–ü–µ—Ä–≤–æ–µ –æ–±–Ω–∞—Ä—É–∂–µ–Ω–∏–µ:</strong> ${new Date(secret.first_scan_date).toLocaleString('ru-RU')}<br>
                            <strong>–ü–æ—Å–ª–µ–¥–Ω–µ–µ –æ–±–Ω–∞—Ä—É–∂–µ–Ω–∏–µ:</strong> ${new Date(secret.last_scan_date).toLocaleString('ru-RU')}<br>
                            <strong>–£–Ω–∏–∫–∞–ª—å–Ω—ã—Ö –∫–æ–º–º–∏—Ç–æ–≤:</strong> ${(secret.unique_commits || []).length}
                        </div>
                    </div>
                </div>
            `;
        }

        function renderPagination() {
            const totalPages = Math.ceil(filteredSecrets.length / pageSize);
            const startIndex = (currentPage - 1) * pageSize + 1;
            const endIndex = Math.min(currentPage * pageSize, filteredSecrets.length);

            const paginationInfo = document.getElementById('paginationInfo');
            if (paginationInfo) {
                paginationInfo.textContent = `–ü–æ–∫–∞–∑–∞–Ω—ã ${startIndex}-${endIndex} –∏–∑ ${filteredSecrets.length} —Å–µ–∫—Ä–µ—Ç–æ–≤`;
            }

            const paginationControls = document.getElementById('paginationControls');
            if (!paginationControls) return;
            
            let controlsHTML = '';

            if (currentPage > 1) {
                controlsHTML += `<button class="pagination-btn" onclick="goToPage(${currentPage - 1})">‚Üê –ü—Ä–µ–¥—ã–¥—É—â–∞—è</button>`;
            } else {
                controlsHTML += `<button class="pagination-btn disabled">‚Üê –ü—Ä–µ–¥—ã–¥—É—â–∞—è</button>`;
            }

            const maxVisiblePages = 5;
            let startPage = Math.max(1, currentPage - Math.floor(maxVisiblePages / 2));
            let endPage = Math.min(totalPages, startPage + maxVisiblePages - 1);
            
            if (endPage - startPage < maxVisiblePages - 1) {
                startPage = Math.max(1, endPage - maxVisiblePages + 1);
            }

            if (startPage > 1) {
                controlsHTML += `<button class="pagination-btn" onclick="goToPage(1)">1</button>`;
                if (startPage > 2) {
                    controlsHTML += `<span style="padding: 0.5rem;">...</span>`;
                }
            }

            for (let i = startPage; i <= endPage; i++) {
                const activeClass = i === currentPage ? 'active' : '';
                controlsHTML += `<button class="pagination-btn ${activeClass}" onclick="goToPage(${i})">${i}</button>`;
            }

            if (endPage < totalPages) {
                if (endPage < totalPages - 1) {
                    controlsHTML += `<span style="padding: 0.5rem;">...</span>`;
                }
                controlsHTML += `<button class="pagination-btn" onclick="goToPage(${totalPages})">${totalPages}</button>`;
            }

            if (currentPage < totalPages) {
                controlsHTML += `<button class="pagination-btn" onclick="goToPage(${currentPage + 1})">–°–ª–µ–¥—É—é—â–∞—è ‚Üí</button>`;
            } else {
                controlsHTML += `<button class="pagination-btn disabled">–°–ª–µ–¥—É—é—â–∞—è ‚Üí</button>`;
            }

            paginationControls.innerHTML = controlsHTML;
        }

        function goToPage(page) {
            const totalPages = Math.ceil(filteredSecrets.length / pageSize);
            if (page >= 1 && page <= totalPages) {
                currentPage = page;
                selectedSecret = null;
                showEmptyDetail();
                updateURL();
                renderTable();
                renderPagination();
            }
        }

        function changePageSize() {
            pageSize = parseInt(document.getElementById('pageSize').value);
            currentPage = 1;
            selectedSecret = null;
            showEmptyDetail();
            updateURL();
            renderTable();
            renderPagination();
        }

        function toggleFiltersPanel() {
            const filtersPanel = document.getElementById('filtersPanel');
            const filtersToggleBtn = document.getElementById('filtersToggleBtn');
            
            if (!filtersPanel || !filtersToggleBtn) {
                console.error('Filters panel elements not found');
                return;
            }
            
            isFiltersOpen = !isFiltersOpen;
            
            if (isFiltersOpen) {
                filtersPanel.classList.add('open');
                filtersToggleBtn.textContent = '‚úñÔ∏è –ó–∞–∫—Ä—ã—Ç—å';
            } else {
                filtersPanel.classList.remove('open');
                filtersToggleBtn.textContent = 'üîç –§–∏–ª—å—Ç—Ä—ã';
            }
        }

        function handleSort(column) {
            const existingSort = sortColumns.find(sort => sort.column === column);
            
            if (existingSort) {
                if (existingSort.direction === 'asc') {
                    existingSort.direction = 'desc';
                } else {
                    sortColumns = [];
                }
            } else {
                sortColumns = [{ column: column, direction: 'asc' }];
            }
            
            sortSecrets();
            renderTable();
            renderPagination();
            setTimeout(updateSortIndicators, 0);
        }

        function updateSortIndicators() {
            document.querySelectorAll('.sortable').forEach(header => {
                header.classList.remove('sort-asc', 'sort-desc');
            });
            
            if (sortColumns.length > 0) {
                const sort = sortColumns[0];
                const header = document.querySelector(`[data-sort="${sort.column}"]`);
                if (header) {
                    header.classList.add(sort.direction === 'asc' ? 'sort-asc' : 'sort-desc');
                }
            }
        }

        function sortSecrets() {
            if (sortColumns.length === 0) {
                filteredSecrets.sort((a, b) => {
                    const dateA = new Date(a.last_scan_date);
                    const dateB = new Date(b.last_scan_date);
                    return dateB - dateA;
                });
                return;
            }

            filteredSecrets.sort((a, b) => {
                for (let sort of sortColumns) {
                    let valueA, valueB;
                    
                    switch (sort.column) {
                        case 'secret':
                            valueA = (a.current_secret || '').toLowerCase();
                            valueB = (b.current_secret || '').toLowerCase();
                            break;
                        case 'file':
                            valueA = (a.path || '').toLowerCase();
                            valueB = (b.path || '').toLowerCase();
                            break;
                        case 'type':
                            valueA = (a.type || '').toLowerCase();
                            valueB = (b.type || '').toLowerCase();
                            break;
                        case 'severity':
                            const severityOrder = { 'High': 2, 'Potential': 1 };
                            valueA = severityOrder[a.severity] || 0;
                            valueB = severityOrder[b.severity] || 0;
                            break;
                        case 'status':
                            const statusOrder = { 'active': 3, 'resolved': 2, 'refuted': 1 };
                            valueA = statusOrder[a.status] || 0;
                            valueB = statusOrder[b.status] || 0;
                            break;
                        case 'history':
                            valueA = (a.unique_commits || []).length;
                            valueB = (b.unique_commits || []).length;
                            break;
                        default:
                            continue;
                    }
                    
                    let comparison = 0;
                    if (valueA < valueB) comparison = -1;
                    else if (valueA > valueB) comparison = 1;
                    
                    if (comparison !== 0) {
                        return sort.direction === 'asc' ? comparison : -comparison;
                    }
                }
                return 0;
            });
        }

        // Initialize when page loads
        document.addEventListener('DOMContentLoaded', function() {
            console.log('Page loading...');
            
            if (!loadSecretsData()) {
                console.error('Failed to load secrets data');
                const tableContainer = document.getElementById('secretsTable');
                if (tableContainer) {
                    tableContainer.innerHTML = `
                        <div class="empty-results">
                            <h3>–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö</h3>
                            <p>–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –¥–∞–Ω–Ω—ã–µ –æ —Å–µ–∫—Ä–µ—Ç–∞—Ö. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –æ–±–Ω–æ–≤–∏—Ç—å —Å—Ç—Ä–∞–Ω–∏—Ü—É.</p>
                            <button onclick="window.location.reload()" class="btn btn-primary">–û–±–Ω–æ–≤–∏—Ç—å —Å—Ç—Ä–∞–Ω–∏—Ü—É</button>
                        </div>
                    `;
                }
                return;
            }
            
            if (allSecretsData.length === 0) {
                console.log('No secrets found');
                const tableContainer = document.getElementById('secretsTable');
                if (tableContainer) {
                    tableContainer.innerHTML = `
                        <div class="empty-results">
                            <h3>üì≠ –°–µ–∫—Ä–µ—Ç—ã –Ω–µ –Ω–∞–π–¥–µ–Ω—ã</h3>
                            <p>–í –∏—Å—Ç–æ—Ä–∏–∏ —ç—Ç–æ–≥–æ –ø—Ä–æ–µ–∫—Ç–∞ –Ω–µ—Ç —Å–µ–∫—Ä–µ—Ç–æ–≤.</p>
                        </div>
                    `;
                }
                return;
            }
            
            console.log('Initializing with', allSecretsData.length, 'secrets');
            console.log('Sample secret:', allSecretsData[0]);
            
            initializeFilters();
            applyFilters();
        });

        // Close filters panel when clicking outside
        document.addEventListener('click', function(e) {
            const filtersPanel = document.getElementById('filtersPanel');
            const filtersToggleBtn = document.getElementById('filtersToggleBtn');
            
            if (isFiltersOpen && 
                !filtersPanel.contains(e.target) && 
                !filtersToggleBtn.contains(e.target)) {
                toggleFiltersPanel();
            }
        });

        // Initialize page from URL parameters
        window.addEventListener('load', function() {
            const urlParams = new URLSearchParams(window.location.search);
            const page = parseInt(urlParams.get('page')) || 1;
            const size = parseInt(urlParams.get('page_size')) || 100;
            
            currentPage = page;
            pageSize = size;
            const pageSizeSelect = document.getElementById('pageSize');
            if (pageSizeSelect) {
                pageSizeSelect.value = size;
            }
        });
    </script>
</body>
</html>